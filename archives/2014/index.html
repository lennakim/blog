<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>归档: 2014 | Shooter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
    <meta name="author" content="shooter">
  
  
  <meta name="description" content="禦風而行 世而譽之而不加勸 世而非之而不加沮">
<meta property="og:type" content="website">
<meta property="og:title" content="Shooter">
<meta property="og:url" content="http://shooter.gl/archives/2014/index.html">
<meta property="og:site_name" content="Shooter">
<meta property="og:description" content="禦風而行 世而譽之而不加勸 世而非之而不加沮">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Shooter">
<meta name="twitter:description" content="禦風而行 世而譽之而不加勸 世而非之而不加沮">
  
    <link rel="alternate" href="/atom.xml" title="Shooter" type="application/atom+xml">
  
  
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>

<body>
  <div class="wrapper">
    <header id="header">
  <div class="title">
    <h1><a href="/">Shooter</a></h1>
    <p><a href="/">I am shooter</a></p>
  </div>
  <nav class="nav">
    <ul>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/about">About</a></li>
      
      
        <li><a href="/atom.xml">RSS</a></li>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
  <div class="clearfix"></div>
</header>
    <div class="content">


<h2 class="archives-title"><span>2014</span></h2>



  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/live-2014-12-31-2014-end/">
  <time datetime="2014-12-30T16:39:56.000Z">
    2014-12-31
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/live-2014-12-31-2014-end/">2014年, 再见</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>莽莽幢幢走过2014, 走过本命年, 波折不断, 惊喜交加, 生命的年轮又多了一圈.</p>
<p>2014-01-01, 我在隆隆的火车上跨了年, 早上到了九江, 短暂的3天是生命里最闪光的时刻.</p>
<p>2014-01-11, 第一次参加rails girl, 走出封闭的小圈子, 认识了很多有趣的人.</p>
<p>2014-01-xx, 公司资金链断裂, 由于在rails girl刷脸的缘故, 应聘<a href="https://yunbi.com/" target="_blank" rel="external">云币</a>成功.</p>
<p>2014-02-07, 正月初八, 在<a href="https://yunbi.com/" target="_blank" rel="external">云币</a> 第一天工作.</p>
<p>2014-03-26, 跟她吵架了.</p>
<p>2014-04-20, <a href="http://knewcoin.com/" target="_blank" rel="external">knewcoin</a> 功能完成, 上线.</p>
<p>2014-05-10, 去了南昌, 看到了她, 然后没了然后.</p>
<p>2014-05-27, 开始 <a href="http://www.meimiaoapp.com/" target="_blank" rel="external">美喵</a>的工作.</p>
<p>2014-06-28, 参加<a href="http://sf.gg/" target="_blank" rel="external">segmentfault</a>举办的黑客马拉松, 天时地利人和, <a href="http://segmentfault.com/blog/news/1190000000593834" target="_blank" rel="external">获奖了</a>.</p>
<p>2014-07-18, 美喵 第一版完成.</p>
<p>2014-09-26, macbook pro 在公司被盗, 买了不到3周时间.</p>
<p>2014-10-15, 美喵 第二版完成, 终告一段落.</p>
<p>2014-10-26, 开始 <a href="http://www.doubao.io/" target="_blank" rel="external">豆包</a>.</p>
<p>2014-11-27, 向<a href="https://github.com/peatio/peatio" target="_blank" rel="external">peatio</a>提交<a href="https://github.com/peatio/peatio/pull/360" target="_blank" rel="external">Deposits api</a>.</p>
<p>2014-12-10, 开始<a href="http://yunaigou.com/" target="_blank" rel="external">云爱购</a>的工作.</p>
<p>2014-12-12, <a href="http://yunaigou.com/" target="_blank" rel="external">云爱购</a> 1212活动, 分水岭.</p>
<p>2014-12-20, 提出休假.</p>
<p>2014-12-21, 到青岛,与CTO谈心, 正式辞职.</p>
<p>2014-12-23, 生日, 从青岛回到北京.</p>
<p>2014-12-24, 交接工作, 不甘, 不舍.</p>
<p>2014-12-31, <strong>\u90b9\u5029\u96ef, I have lost you!</strong>.</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/live-2014-12-21-a-trip-to-qingdao/">
  <time datetime="2014-12-21T02:00:33.000Z">
    2014-12-21
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/live-2014-12-21-a-trip-to-qingdao/">青岛之行</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>今天坐高铁, 从北京到青岛,跟CTO 丹政委做一些工作上的交接.<br>高铁要先绕道天津、德州再到青岛, 这走的是京沪线啊.</p>
<p>之前来过一次青岛, 大概是13年5月份, 那时候刚离职, 拉上朋友去散心.<br>先坐车到济南, 在济南呆了一段时间, 见了在机械厂工作的表哥.<br>他那时候刚开始工作, 额 <strong>我也不知道我换了几份工作了</strong>.</p>
<p>在济南看到了传说中的<strong>大明湖畔</strong>, 脑海里首先浮现的不是夏雨荷,<br>而是<strong>容嬷嬷俊俏的脸庞</strong>, 想起了当年红遍大江南北的小燕子,<br>那时候真的是青葱岁月, 比青葱还青葱, 真正的葱心绿, 我才10多岁啊.</p>
<p>在青岛,第一次看到了海, 貌似这个时间点来的晚了些, 有平淡的小激动.<br>到青岛的时间段不是太好, 正好赶上旅游高峰, 每一个景点, 往上看是各种腿, 往下看是各种头.<br>夹在人流中, 一步一步挪动, 随波逐流, 随大流, 不踩脚.</p>
<p>在海洋馆, 见识了很多光怪离奇的鱼, 其他有印象的没印象的海洋生物, 里面闷热难耐, 逛完就赶紧撤退了.</p>
<p>逛了金银沙滩, 闻着带腥味的海风, 光着脚丫子, 踩在沙滩上.<br>刚接触沙滩,感觉有很多小虫子从脚上爬过.<br>在另个地方, 抓了点小螃蟹, 还想带回来煎炸烹煮下, 来顿螃蟹大餐.</p>
<p>在 栈桥, 鲁迅公园, 五四广场, 四处流窜活动, 坐一辆辆公交车, 吃着叫不上名字的东西, 记忆模糊了.</p>
<p>这的地形跟华北平原真的不一样, 我在北京、老家的城市, 没见过这么起伏的道路.<br>看着公交车从陡坡上驶过来, 在我眼里忽的变大, 像要撞过来一样.</p>
<p>青岛的地理位置, 在我的感觉来说, <strong>北京以南, 南方已北, </strong> 不南不北, 应该更适北方人生活吧.<br>我忍受不了 南方冬天室内 1℃的气温, 阴冷潮湿, 没有暖气, <strong>取暖靠抖</strong>, 生活好艰难.</p>
<p>青岛算是我的福地, 上次来散心回到北京后,认识了她, 额 现在不知道她过的好不好.</p>
<p>现在想起之前的事儿, 颇有『庭有枇杷树,今已亭亭如盖矣』的赶脚儿.</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/tech-2014-12-16-ios-demo-for-swift/">
  <time datetime="2014-12-16T05:06:55.000Z">
    2014-12-16
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/tech-2014-12-16-ios-demo-for-swift/">尝试用swift写一个ios app demo</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>10-1假期, 闲来无事, 写了个<a href="http://github.com/liuningtw/timerDemo" target="_blank" rel="external">计时器</a>.<br>之前没有 <strong>object-c</strong>, <strong>swift</strong> 经验, 基本是依葫芦画瓢.</p>
<p><a href="http://swiftist.org/topics/96" target="_blank" rel="external">教程</a>是<a href="http://swiftist.org/~lifedim" target="_blank" rel="external">Jason</a>编写的, 很详细,另外有一个bug, Jason希望大家能发现, 并帮他修复. 感觉这种发现问题的方式很不错丫.</p>
<p>核心是一个 <strong>CounterViewController.swift</strong> 文件</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#10;import UIKit&#10;&#10;class CounterViewController: UIViewController &#123;&#10;&#10;    override func viewDidLoad() &#123;&#10;        super.viewDidLoad()&#10;        self.view.backgroundColor = UIColor.whiteColor()&#10;&#10;        setupTimeLabel()&#10;        setuptimeButtons()&#10;        setupActionButtons()&#10;&#10;        remainingSeconds = 0&#10;    &#125;&#10;&#10;    override func didReceiveMemoryWarning() &#123;&#10;        super.didReceiveMemoryWarning()&#10;        // Dispose of any resources that can be recreated.&#10;    &#125;&#10;&#10;    override func viewWillLayoutSubviews() &#123;&#10;        super.viewWillLayoutSubviews()&#10;&#10;        timeLabel!.frame = CGRectMake(10, 40, self.view.bounds.size.width-20, 120)&#10;&#10;        let gap = ( self.view.bounds.size.width - 10*2 - (CGFloat(timeButtons!.count) * 64) ) / CGFloat(timeButtons!.count - 1)&#10;&#10;        for (index, button) in enumerate(timeButtons!) &#123;&#10;            let buttonLeft = 10 + (64 + gap) * CGFloat(index)&#10;&#10;            button.frame = CGRectMake(buttonLeft, self.view.bounds.size.height-120, 64, 44)&#10;        &#125;&#10;&#10;        startStopButton!.frame = CGRectMake(10, self.view.bounds.size.height - 60, self.view.bounds.size.width-20-120, 44)&#10;&#10;        clearButton!.frame = CGRectMake(10+self.view.bounds.size.width-20-100+20, self.view.bounds.size.height-60, 80, 44)&#10;    &#125;&#10;&#10;    ///UI Element&#10;    var timeLabel: UILabel? //&#26174;&#31034;&#21097;&#20313;&#26102;&#38388;&#10;    var timeButtons: [UIButton]? //&#35774;&#32622;&#26102;&#38388;&#30340;&#25353;&#38062;&#25968;&#32452;&#10;    var startStopButton: UIButton? //&#21551;&#21160;/&#20572;&#27490;&#25353;&#38062;&#10;    var clearButton: UIButton? //&#22797;&#20301;&#25353;&#38062;&#10;    let timeButtonInfos = [(&#34;1&#20998;&#34;, 60), (&#34;3&#20998;&#34;, 180), (&#34;5&#20998;&#34;, 300), (&#34;&#31186;&#34;, 1)]&#10;&#10;&#10;    //&#21551;&#21160;&#25110;&#20572;&#27490;&#20498;&#35745;&#26102;&#10;    //&#20351;&#29992;Swift&#30340;&#26041;&#24335;&#26469;&#35299;&#20915;&#29366;&#24577;&#36319;UI&#30340;&#21516;&#27493;&#38382;&#39064;&#65306;&#20351;&#29992;&#23646;&#24615;&#30340;willSet&#25110;didSet&#26041;&#27861;&#10;    var isCounting: Bool = false &#123;&#10;        willSet(newValue) &#123;&#10;            if newValue &#123;&#10;                timer = NSTimer.scheduledTimerWithTimeInterval(1, target: self, selector: &#34;updateTimer:&#34;, userInfo: nil, repeats: true)&#10;            &#125; else &#123;&#10;                timer?.invalidate()&#10;                timer = nil&#10;            &#125;&#10;&#10;            setSettingButtonsEnabled(!newValue)&#10;        &#125;&#10;    &#125;&#10;&#10;    var timer: NSTimer? // &#35774;&#32622;&#23450;&#26102;&#22120;&#10;&#10;    //&#20351;&#29992;Swift&#30340;&#26041;&#24335;&#26469;&#35299;&#20915;&#29366;&#24577;&#36319;UI&#30340;&#21516;&#27493;&#38382;&#39064;&#65306;&#20351;&#29992;&#23646;&#24615;&#30340;willSet&#25110;didSet&#26041;&#27861;&#10;    var remainingSeconds: Int = 0 &#123;&#10;&#10;        willSet(newSeconds) &#123;&#10;            let mins = newSeconds / 60&#10;            let seconds =  newSeconds % 60&#10;&#10;            timeLabel!.text = NSString(format: &#34;%02d:%02d&#34;, mins, seconds)&#10;&#10;            if newSeconds &#60;= 0 &#123;&#10;                isCounting = false&#10;                startStopButton!.alpha = 0.3&#10;                startStopButton!.enabled = false&#10;            &#125; else&#123;&#10;                startStopButton!.alpha = 1.0&#10;                startStopButton!.enabled = true&#10;            &#125;&#10;        &#125;&#10;    &#125;&#10;&#10;    //UI Controls&#10;&#10;    func setupTimeLabel() &#123;&#10;        timeLabel = UILabel()&#10;        timeLabel!.textColor = UIColor.whiteColor()&#10;        timeLabel!.font = UIFont(name: &#34;Helvetica&#34;, size: 80)&#10;        timeLabel!.backgroundColor = UIColor.blackColor()&#10;        timeLabel!.textAlignment = NSTextAlignment.Center&#10;&#10;        self.view.addSubview(timeLabel!)&#10;    &#125;&#10;&#10;    func setuptimeButtons() &#123;&#10;        var buttons: [UIButton] = []&#10;&#10;        for (index, (title, _)) in enumerate(timeButtonInfos) &#123;&#10;&#10;            let button: UIButton = UIButton()&#10;            button.tag = index //&#20445;&#23384;&#25353;&#38062;&#30340;index&#10;            button.setTitle(&#34;\(title)&#34;, forState: UIControlState.Normal)&#10;&#10;            button.backgroundColor = UIColor.orangeColor()&#10;            button.setTitleColor(UIColor.whiteColor(), forState: UIControlState.Normal)&#10;            button.setTitleColor(UIColor.blackColor(), forState: UIControlState.Highlighted)&#10;&#10;            button.addTarget(self, action: &#34;timeButtonTapped:&#34;, forControlEvents: UIControlEvents.TouchUpInside)&#10;&#10;            buttons += [button]&#10;            self.view.addSubview(button)&#10;&#10;        &#125;&#10;&#10;        timeButtons = buttons&#10;    &#125;&#10;&#10;    func setupActionButtons() &#123;&#10;        //create start/stop button&#10;&#10;        startStopButton = UIButton()&#10;&#10;        startStopButton!.setTitle(&#34;&#21551;&#21160;/&#20572;&#27490;&#34;, forState: UIControlState.Normal)&#10;&#10;        startStopButton!.backgroundColor = UIColor.redColor()&#10;&#10;        startStopButton!.setTitleColor(UIColor.blackColor(), forState: UIControlState.Normal)&#10;&#10;        // &#20026;button&#32465;&#23450;TouchUpInside&#20107;&#20214;&#10;        startStopButton!.addTarget(self, action: &#34;startStopButtonTapped:&#34;, forControlEvents: UIControlEvents.TouchUpInside)&#10;&#10;        self.view.addSubview(startStopButton!)&#10;&#10;        /////////////////////clearButton/////////////////////&#10;&#10;        clearButton = UIButton()&#10;&#10;        clearButton!.setTitle(&#34;&#22797;&#20301;&#34;, forState: UIControlState.Normal)&#10;&#10;        clearButton!.backgroundColor = UIColor.redColor()&#10;&#10;        clearButton!.setTitleColor(UIColor.whiteColor(), forState: UIControlState.Normal)&#10;&#10;        clearButton!.setTitleColor(UIColor.blackColor(), forState: UIControlState.Highlighted)&#10;&#10;        clearButton!.addTarget(self, action: &#34;clearButtonTapped:&#34;, forControlEvents: UIControlEvents.TouchUpInside)&#10;&#10;        self.view.addSubview(clearButton!)&#10;&#10;    &#125;&#10;&#10;    ///Actions &#38; Callbacks&#10;    func startStopButtonTapped(sender: UIButton) &#123;&#10;        isCounting = !isCounting //&#20999;&#25442;&#20102;isCounting&#30340;&#29366;&#24577;&#10;&#10;        if isCounting &#123;&#10;            createAndFireLocalNotificationAfterSeconds(remainingSeconds)&#10;        &#125; else &#123;&#10;            UIApplication.sharedApplication().cancelAllLocalNotifications()&#10;        &#125;&#10;    &#125;&#10;&#10;    func clearButtonTapped(sender: UIButton) &#123;&#10;        remainingSeconds = 0  //&#22797;&#20301;&#25353;&#38062;&#23558;&#26102;&#38388;&#32622;0&#10;    &#125;&#10;&#10;    //&#32047;&#21152;&#26102;&#38388;&#10;    func timeButtonTapped(sender: UIButton) &#123;&#10;        let (_, seconds) = timeButtonInfos[sender.tag]&#10;        remainingSeconds += seconds&#10;    &#125;&#10;&#10;    func updateTimer(timer: NSTimer) &#123;&#10;        remainingSeconds -= 1&#10;&#10;        // &#24377;&#20986;&#35686;&#21578;&#31383;&#21475;,&#25552;&#31034;&#20498;&#35745;&#26102;&#23436;&#25104;&#10;        if remainingSeconds &#60;= 0 &#123;&#10;            let alert = UIAlertView()&#10;&#10;            alert.title = &#34;&#35745;&#26102;&#23436;&#25104;&#34;&#10;            alert.message = &#34;&#34;&#10;            alert.addButtonWithTitle(&#34;OK&#34;)&#10;            alert.show()&#10;        &#125;&#10;    &#125;&#10;&#10;    ///&#10;&#10;    func setSettingButtonsEnabled(enabled: Bool) &#123;&#10;        for button in timeButtons! &#123;&#10;            button.enabled = enabled&#10;            button.alpha = enabled ? 1.0 : 0.3&#10;        &#125;&#10;&#10;        clearButton!.enabled = enabled&#10;        clearButton!.alpha = enabled ? 1.0 : 0.3&#10;    &#125;&#10;&#10;    //&#27880;&#20876;&#31995;&#32479;&#36890;&#30693;&#10;    func createAndFireLocalNotificationAfterSeconds(seconds: Int) &#123;&#10;&#10;        UIApplication.sharedApplication().cancelAllLocalNotifications()&#10;        let notification = UILocalNotification()&#10;&#10;        let timeIntervalSinceNow = Double(seconds)&#10;&#10;        notification.fireDate = NSDate(timeIntervalSinceNow:timeIntervalSinceNow);&#10;&#10;        notification.timeZone = NSTimeZone.systemTimeZone()&#10;        notification.alertBody = &#34;&#35745;&#26102;&#23436;&#25104;&#65281;&#34;&#10;&#10;        UIApplication.sharedApplication().scheduleLocalNotification(notification)&#10;&#10;    &#125;&#10;&#10;&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>从 simulator上测试, 到真机上运行, 花了很多时间, 要申请开发者, 要 <strong>bundle id</strong>, 下载开发者证书 …<br>各种东西,步骤已经忘了, 现在没时间折腾了.</p>
<p>效果如下:</p>
<p><img src="http://7sbqv9.com1.z0.glb.clouddn.com/ios-demo-for-swift-001.PNG" alt=""><br><img src="http://7sbqv9.com1.z0.glb.clouddn.com/ios-demo-for-swift-002.PNG" alt=""></p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/tech-2014-12-15-elasticsearch-with-ransack-search-method-conflicting/">
  <time datetime="2014-12-15T06:36:28.000Z">
    2014-12-15
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/tech-2014-12-15-elasticsearch-with-ransack-search-method-conflicting/">Elasticsearch 与 Ransack 的 search 方法冲突</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>最近在项目中用 <a href="http://www.elasticsearch.org/" target="_blank" rel="external">Elasticsearch</a> 做全文搜索,<br>由于在之前用到 <a href="https://github.com/activerecord-hackery/ransack" target="_blank" rel="external">Ransack</a> 做模糊搜索,<br>这2个gem都在model中添加了 <code>search</code> 方法,一起使用会造成冲突.</p>
<p>于是找到一个解决办法 <a href="https://github.com/elasticsearch/elasticsearch-rails/issues/96" target="_blank" rel="external">es-rails-issues-96</a>.</p>
<p>1 引入gem</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">gem <span class="string">"ransack"</span></span><br><span class="line">gem <span class="string">"elasticsearch-model"</span></span><br><span class="line">gem <span class="string">"elasticsearch-rails"</span></span><br></pre></td></tr></table></figure>
<p>2 include Elasticsearch::Model</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /models/article.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span> <span class="inheritance">&lt; <span class="parent">ActiveRecord::Base</span></span></span></span><br><span class="line">  <span class="keyword">include</span> <span class="constant">Elasticsearch::Model</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><code>Article.search</code>可以使用了, 由于上边说到的原因,  Elasticsearch search 方法会被 Ransack覆盖.</p>
<p>3 解决办法</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /models/article.rb</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">search_with_es</span><span class="params">(*args)</span></span></span><br><span class="line">  __elasticsearch_<span class="number">_</span>.search(*args)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>使用 <code>Article.search_with_es</code> 即可.</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/tech-2014-12-14-segmentation-routes/">
  <time datetime="2014-12-14T03:08:09.000Z">
    2014-12-14
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/tech-2014-12-14-segmentation-routes/">分割rails中的routes文件</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>在rails项目中有一个非常重要的文件 <code>routes.rb</code>, 管理rails的请求路径.<br>在随着项目的膨胀, routes.rb 会越来越大, 分割routes会使目录结构更加清晰.</p>
<hr>
<p>1 先在 config 下新建 routes 文件夹,<br>2 然后将routes.rb 拆分放到不同的文件夹内,<br>3 再然后加载拆分后的文件, 有两种方式:</p>
<h4 id="第一种">第一种</h4><p>在 <code>config/routes.rb</code> 中定义 <code>draw</code> Method:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActionDispatch::Routing::Mapper</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">draw</span><span class="params">(routes_name)</span></span></span><br><span class="line">  instance_eval(<span class="constant">File</span>.read(<span class="constant">Rails</span>.root.join(<span class="string">"config/routes/<span class="subst">#&#123;routes_name&#125;</span>.rb"</span>)))</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">draw <span class="symbol">:admin</span></span><br></pre></td></tr></table></figure>
<h4 id="第二种">第二种</h4><p>更改 <code>application.rb</code> 的 <code>load path</code></p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">config.paths[<span class="string">"config/routes"</span>] += <span class="constant">Dir</span>[<span class="constant">Rails</span>.root.join(<span class="string">"config/routes/*.rb"</span>)]</span><br></pre></td></tr></table></figure>
<p>如果你的 routes 非常依赖顺序, 需要逐步加载文件</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 逐个加载</span></span><br><span class="line">config.paths.config.routes &lt;&lt; <span class="constant">File</span>.join(<span class="constant">Rails</span>.root, <span class="string">"config/routes/routes_01.rb"</span>)</span><br><span class="line">config.paths.config.routes &lt;&lt; <span class="constant">File</span>.join(<span class="constant">Rails</span>.root, <span class="string">"config/routes/routes_02.rb"</span>)</span><br><span class="line">config.paths.config.routes &lt;&lt; <span class="constant">File</span>.join(<span class="constant">Rails</span>.root, <span class="string">"config/routes/routes_03.rb"</span>)</span><br></pre></td></tr></table></figure>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/tech-2014-12-12-use-sql-check-physical-size-of-databases/">
  <time datetime="2014-12-12T09:57:25.000Z">
    2014-12-12
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/tech-2014-12-12-use-sql-check-physical-size-of-databases/">sql查询某个数据库每个表占用的空间大小</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>如图</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+-----------------------+---------+&#10;| Table                 | MB      |&#10;+-----------------------+---------+&#10;| account_versions      | 2752.97 |&#10;| fund_sources          |    0.20 |&#10;| id_documents          |    0.41 |&#10;| identities            |    1.52 |&#10;| members               |    1.52 |&#10;| orders                | 1355.75 |&#10;| partial_trees         |  671.02 |&#10;| payment_addresses     |    1.88 |&#10;| tips                  |    0.02 |&#10;| tokens                |    2.89 |&#10;| trades                |  229.94 |&#10;| two_factors           |    0.48 |&#10;| versions              |   46.08 |&#10;| withdraws             |    1.52 |&#10;+-----------------------+---------+</span><br></pre></td></tr></table></figure>
<p>sql语句如下:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">SELECT</span> table_name <span class="keyword">AS</span> <span class="string">"Tables"</span>,</span><br><span class="line"><span class="keyword">round</span>(((data_length + index_length) / <span class="number">1024</span> / <span class="number">1024</span>), <span class="number">2</span>) <span class="string">"Size in MB"</span></span><br><span class="line"><span class="keyword">FROM</span> information_schema.<span class="keyword">TABLES</span></span><br><span class="line"><span class="keyword">WHERE</span> table_schema = <span class="string">"&lt;DB_NAME&gt;"</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (data_length + index_length) <span class="keyword">DESC</span>;</span></span><br></pre></td></tr></table></figure>
<p>把 DB_NAME替换成需要查询的数据库名即可, 应该只适用于 Mysql / MariaDB.</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/tech-2014-10-10-good-luck-shooter/">
  <time datetime="2014-10-10T06:36:28.000Z">
    2014-10-10
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/tech-2014-10-10-good-luck-shooter/">good luck shooter</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>之前用 <a href="http://octopress.org/" target="_blank" rel="external">octopress</a>, 基于ruby语言开发, 慢慢感觉 octopress<br>不是轻量级的, 配置很繁琐, 安装ruby也是一件麻烦事 .<br>而 Hexo 是基于nodejs语言开发, 安装nodejs还是很方便的, 果断易主了 .<br>感兴趣的小伙伴, 可以查看一下Hexo的<a href="http://hexo.io/docs/" target="_blank" rel="external">文档</a> .</p>
<p>恰逢 <a href="http://shooter.cn/" target="_blank" rel="external">射手网</a>关站, 不免感到惋惜 .<br>在朋友的介绍下, 买下了 shooter.gl, gl是个格陵兰群岛域名, 买这个域名的寓意就是 <strong>shooter good luck</strong>!<br>希望能有好运气!   come on shooter!</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/tech-2014-07-18-grape-header/">
  <time datetime="2014-07-18T10:04:15.000Z">
    2014-07-18
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/tech-2014-07-18-grape-header/">从grape中获取header数据</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p><a href="https://github.com/intridea/grape" target="_blank" rel="external">grape</a> 是一个方便创建 REST-like APIs的gem.</p>
<p>client将一些元数据存在header中, 需要从grape中获取header数据, 得到version版本, 直接上代码.</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_client_version</span></span></span><br><span class="line">  request = <span class="constant">Grape::Request</span>.new(env)</span><br><span class="line">  headers = request.headers</span><br><span class="line">  version = headers[<span class="string">'X-Version'</span>].to_s</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/tech-2014-05-07-emacs-shortcuts/">
  <time datetime="2014-05-07T09:37:07.000Z">
    2014-05-07
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/tech-2014-05-07-emacs-shortcuts/">在shell中使用emacs快捷键</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>最近买了个 <a href="http://zh.wikipedia.org/wiki/Happy_Hacking_Keyboard" target="_blank" rel="external">hhkb</a> 白色无刻, 跟一般的键盘差别太大, 没有方向键, 在shell中移动光标太麻烦.</p>
<p>shell 有 <strong>editing-mode</strong>, 默认是 emacs-mode, 所以emacs快捷键在shell中生效, 故记下几个emacs快捷键.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ctrl+a &#21040;&#34892;&#39318;&#10;ctrl+e &#21040;&#34892;&#23614;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ctrl+u &#20174;&#20809;&#26631;&#22788;&#21024;&#38500;&#21040;&#34892;&#39318; #&#22312;zsh&#29615;&#22659;&#19979;&#22833;&#25928;, &#35299;&#20915;&#26041;&#27861;&#24050;&#34917;&#20805;&#10;ctrl+k &#20174;&#20809;&#26631;&#22788;&#21024;&#38500;&#21040;&#34892;&#23614;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ctrl+f &#20809;&#26631;&#21069;&#31227;&#10;ctrl+b &#20809;&#26631;&#21518;&#36864;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ctrl+p shell&#20013;&#19978;&#19968;&#20010;&#21629;&#20196;, &#25110;&#32773; &#25991;&#26412;&#20013;&#31227;&#21160;&#21040;&#19978;&#19968;&#34892;&#10;ctrl+n shell&#20013;&#19979;&#19968;&#20010;&#21629;&#20196;, &#25110;&#32773; &#25991;&#26412;&#20013;&#31227;&#21160;&#21040;&#19979;&#19968;&#34892;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ctrl+r &#24448;&#21518;&#25628;&#32034;&#21382;&#21490;&#21629;&#20196;&#10;ctrl+s &#24448;&#21069;&#25628;&#32034;&#21382;&#21490;&#21629;&#20196;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ctrl+d &#21024;&#38500;&#19968;&#20010;&#23383;&#31526;, &#21024;&#38500;&#19968;&#20010;&#23383;&#31526;, &#30456;&#24403;&#20110;&#36890;&#24120;&#30340;Delete&#38190;&#10;ctrl+h &#36864;&#26684;&#21024;&#38500;&#19968;&#20010;&#23383;&#31526;, &#30456;&#24403;&#20110;&#36890;&#24120;&#30340;Backspace&#38190;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ctrl+y &#31896;&#36148;&#10;ctrl+l &#28165;&#29702;&#23631;&#24149;, &#31867;&#20284;clear</span><br></pre></td></tr></table></figure>
<hr>
<p>补充: 2015-01-05</p>
<h3 id="解决_ctrl+u_在zsh环境下失效的问题">解决 ctrl+u 在<a href="http://www.zsh.org/" target="_blank" rel="external">zsh</a>环境下失效的问题</h3><p>按照<a href="http://stackoverflow.com/questions/3483604/which-shortcut-in-zsh-does-the-same-as-ctrl-u-in-bash" target="_blank" rel="external">which-shortcut-in-zsh-does-the-same-as-ctrl-u-in-bash</a>,<br>在<code>.zshrc</code> 文件写入 <code>bindkey \^U backward-kill-line</code> 即可.</p>
<h3 id="设置shell_editing-mode_为_vi-mode">设置shell editing-mode 为 vi-mode</h3><p>在shell中输入 <code>set -o vi</code>, 或者在shell配置文件中写入 <code>set -o vi</code>,<br>按下 Esc, 输入 hjkl 就可以在shell中移动光标了.</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/tech-2014-01-15-rails-view-best-practices/">
  <time datetime="2014-01-15T14:18:18.000Z">
    2014-01-15
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/tech-2014-01-15-rails-view-best-practices/">rails 页面最佳实践</a></h1>
  

  </header>
  
  <div class="entry">
    
      <h2 id="什么是好的_view">什么是好的 view</h2><h3 id="为什么需要最佳实践？">为什么需要最佳实践？</h3><ul>
<li>项目太大，难懂</li>
<li>团队编程风格不同</li>
</ul>
<h3 id="你的_View_可能正面临的问题">你的 View 可能正面临的问题</h3><ul>
<li>Complex UI with logic UI 和代码逻辑纠缠在一起</li>
<li>Too long to maintain 代码太长难以维护</li>
<li>Low performance 性能不好</li>
<li>Security issues 容易产生安全问题</li>
</ul>
<h3 id="什么是好的代码">什么是好的代码</h3><ul>
<li>Readability 易读，容易了解</li>
<li>Flexibility 弹性，容易扩充</li>
<li>Effective 效率，写码快速</li>
<li>Maintainability 维护性，容易找到问题</li>
<li>Consistency 一致性，遵循管理无须死背</li>
<li>Testability 可测行，容易编写测试</li>
</ul>
<h2 id="18招技巧">18招技巧</h2><h3 id="No-1_Move_logic_to_helper">No.1 Move logic to helper</h3><p>BAD:</p>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"></span>&lt;%<span class="ruby"> <span class="keyword">if</span> current_user &amp;&amp; current_user == post.user </span>%&gt;<span class="xml"></span><br><span class="line">  </span>&lt;%=<span class="ruby"> link_to(<span class="string">"Edit"</span>, edit_post_path(post))</span>%&gt;<span class="xml"></span><br><span class="line"></span>&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;<span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>GOOD:</p>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"></span>&lt;%<span class="ruby"> <span class="keyword">if</span> editable?(post) </span>%&gt;<span class="xml"></span><br><span class="line">  </span>&lt;%=<span class="ruby"> link_to(<span class="string">"Edit"</span>, edit_post_path(post))</span>%&gt;<span class="xml"></span><br><span class="line"></span>&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;<span class="xml"></span></span><br></pre></td></tr></table></figure>
<h3 id="No-2_Pre-decorate_with_Helper">No.2 Pre-decorate with Helper</h3><p>经常用的地方先用 helper 整理</p>
<p>BAD:</p>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"></span>&lt;%=<span class="ruby"> <span class="variable">@topic</span>.content </span>%&gt;<span class="xml"></span></span><br></pre></td></tr></table></figure>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"></span>&lt;%=<span class="ruby"> auto_link(truncate(simple_format(topic.content)), <span class="symbol">:length</span> =&gt; <span class="number">100</span>) </span>%&gt;<span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>GOOD:</p>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"></span>&lt;%=<span class="ruby"> render_post_content(<span class="variable">@topic</span>.content) </span>%&gt;<span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>Common Case</p>
<ul>
<li>render_post_author</li>
<li>render_post_published_date</li>
<li>render_post_title</li>
<li>render_post_content</li>
</ul>
<h3 id="No-3_Use_Ruby_in_Helper_ALL_THE_TIME">No.3 Use Ruby in Helper ALL THE TIME</h3><p>在 Helper 中只使用 Ruby 代码，而不要混杂 HTML。因为如果在 Helper 中最后调用 <strong>raw</strong> 或者 <strong>html_safe</strong> 会让代码有被 javascript 攻击的危险</p>
<p>BAD:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_post_taglist</span><span class="params">(post, opts = &#123;&#125;)</span></span></span><br><span class="line">  <span class="comment"># ....</span></span><br><span class="line">   raw tags.collect &#123; |tag|  <span class="string">"&lt;a href=\"<span class="subst">#&#123;posts_path(<span class="symbol">:tag</span> =&gt; tag)&#125;</span>\" class=\"tag\"&gt;<span class="subst">#&#123;tag&#125;</span>&lt;/a&gt;"</span> &#125;.join(<span class="string">", "</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>GOOD:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_post_taglist</span><span class="params">(post, opts = &#123;&#125;)</span></span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">  raw tags.collect &#123; |tag| link_to(tag,posts_path(<span class="symbol">:tag</span> =&gt; tag)) &#125;.join(<span class="string">", "</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="No-4_mix_Helper_&amp;_Partial">No.4 mix Helper &amp; Partial</h3><p>在 Helper 中可以混合使用 Partial</p>
<p>BAD:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_post_title</span><span class="params">(post)</span></span></span><br><span class="line">  str = <span class="string">""</span></span><br><span class="line">  str += <span class="string">"&lt;li&gt;"</span></span><br><span class="line">  str += link_to(post.title, post_path(post))</span><br><span class="line">  str += <span class="string">"&lt;/li&gt;"</span></span><br><span class="line">  <span class="keyword">return</span> raw(str)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>GOOD:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_post_title</span><span class="params">(post)</span></span></span><br><span class="line">  render <span class="symbol">:partial</span> =&gt; <span class="string">"posts/title_for_helper"</span>, <span class="symbol">:locals</span> =&gt;</span><br><span class="line">&#123; <span class="symbol">:title</span> =&gt; post.title &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="No-5_Tell,_Don’t_ask">No.5 Tell, Don’t ask</h3><p>先 Query 再传入 Helper。这样可以避免效能低下的问题。</p>
<p>BAD:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_post_taglist</span><span class="params">(post, opts = &#123;&#125;)</span></span></span><br><span class="line">  tags = post.tags</span><br><span class="line">  tags.collect &#123; |tag| link_to(tag, posts_path(<span class="symbol">tag:</span> tag)) &#125;.join(<span class="string">", "</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"></span>&lt;%<span class="ruby"> <span class="variable">@posts</span>.each <span class="keyword">do</span> |post| </span>%&gt;<span class="xml"></span><br><span class="line">  </span>&lt;%=<span class="ruby"> render_post_taglist(post) </span>%&gt;<span class="xml"></span><br><span class="line"></span>&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;<span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>GOOD:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_post_taglist</span><span class="params">(tags, opts = &#123;&#125;)</span></span></span><br><span class="line">  tags.collect &#123; |tag| link_to(tag, posts_path(<span class="symbol">tag:</span> tag)) &#125;.join(<span class="string">", "</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"></span>&lt;%<span class="ruby"> <span class="variable">@posts</span>.each <span class="keyword">do</span> |post| </span>%&gt;<span class="xml"></span><br><span class="line">    </span>&lt;%=<span class="ruby"> render_post_taglist(post.tags) </span>%&gt;<span class="xml"></span><br><span class="line"></span>&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;<span class="xml"></span><br><span class="line"></span><br><span class="line">def index</span><br><span class="line">  @posts = Post.recent.includes(:tags)</span><br><span class="line">end</span></span><br></pre></td></tr></table></figure>
<h3 id="No-6_Wrap_into_a_method">No.6 Wrap into a method</h3><p>属性尽量包装成 method 而不是放在 helper 中</p>
<p>BAD:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_comment_author</span><span class="params">(comment)</span></span></span><br><span class="line">  <span class="keyword">if</span> comment.user.present?</span><br><span class="line">    comment.user.name</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    comment.custom_name</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>GOOD:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_comment_author</span><span class="params">(comment)</span></span></span><br><span class="line">  comment.author_name</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span> <span class="inheritance">&lt; <span class="parent">ActiveRecord::Base</span></span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">author_name</span></span></span><br><span class="line">    <span class="keyword">if</span> user.present?</span><br><span class="line">      user.name</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      custom_name</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="No-7_Move_code_to_Partial">No.7 Move code to Partial</h3><p>view code 超过两页请注意</p>
<ul>
<li>highly duplicated 内容高度重复</li>
<li>independent blocks 可以独立作为功能区块</li>
</ul>
<p>Common Case</p>
<ul>
<li>nav/user_info</li>
<li>nav/admin_menu</li>
<li>vendor_js/google_analytics</li>
<li>vendor_js/disqus_js</li>
<li>global/footer</li>
</ul>
<h3 id="No-8_Use_presenter_to_clean_the_view">No.8 Use presenter to clean the view</h3><p>使⽤ Presenter 解決 login in view 问题</p>
<p>BAD:</p>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"></span>&lt;%=<span class="ruby"> <span class="keyword">if</span> user_rofile.has_experience? &amp;&amp; user_rofile.experience_public? </span>%&gt;<span class="xml"></span><br><span class="line">  <span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;<span class="title">strong</span>&gt;</span>Experience:<span class="tag">&lt;/<span class="title">strong</span>&gt;</span> </span>&lt;%=<span class="ruby"> user_profile.experience </span>%&gt;<span class="xml"><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"></span>&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;<span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>GOOD:</p>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"></span>&lt;%<span class="ruby"> user_profile.with_experience <span class="keyword">do</span> </span>%&gt;<span class="xml"></span><br><span class="line">  <span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;<span class="title">strong</span>&gt;</span>Experience:<span class="tag">&lt;/<span class="title">strong</span>&gt;</span> </span>&lt;%=<span class="ruby"> user_profile.experience </span>%&gt;<span class="xml"><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"></span>&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;<span class="xml"></span><br><span class="line"></span>&lt;%<span class="ruby"> user_profile.with_hobbies <span class="keyword">do</span> </span>%&gt;<span class="xml"></span><br><span class="line">  <span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;<span class="title">strong</span>&gt;</span>Hobbies:<span class="tag">&lt;<span class="title">strong</span>&gt;</span> </span>&lt;%=<span class="ruby"> user_profile.hobbies </span>%&gt;<span class="xml"><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"></span>&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;<span class="xml"></span></span><br></pre></td></tr></table></figure>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProfilePresenter</span> <span class="inheritance">&lt; </span>::<span class="title">Presenter</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">with_experience</span><span class="params">(&amp;block)</span></span></span><br><span class="line">    <span class="keyword">if</span> profile.has_experience? &amp;&amp; profile.experience_public?</span><br><span class="line">      block.call(view)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><strong>关于 presenter 的延伸阅读</strong></p>
<ul>
<li><a href="http://mikepackdev.com/blog_posts/31-exhibit-vs-presenter" target="_blank" rel="external">Exhibit vs Presenter</a></li>
<li><a href="http://stackoverflow.com/questions/15212637/using-presenters-in-rails" target="_blank" rel="external">Using Presenters in rails</a></li>
<li><a href="http://railscasts.com/episodes/287-presenters-from-scratch" target="_blank" rel="external">Presenters from Scratch</a></li>
<li><a href="http://blog.jayfields.com/2007/03/rails-presenter-pattern.html" target="_blank" rel="external">Rails: Presenter Pattern</a></li>
<li><a href="http://new-bamboo.co.uk/blog/2013/04/17/rails-presenters-skinny-everything" target="_blank" rel="external">Rails Presenters – Skinny Everything</a></li>
</ul>
<h3 id="No-9_Cache_Digest">No.9 Cache Digest</h3><p>过去的页面缓存，我们需要自己管理版本，很难维护。新的 digest 缓存策略会自动失效。</p>
<p>BAD:</p>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"></span>&lt;%<span class="ruby"> cache [v15,<span class="variable">@project</span>] <span class="keyword">do</span> </span>%&gt;<span class="xml"></span><br><span class="line">  aaa</span><br><span class="line">  </span>&lt;%<span class="ruby"> cache [v1<span class="number">0</span>,<span class="variable">@todo</span>] <span class="keyword">do</span> </span>%&gt;<span class="xml"></span><br><span class="line">    bbb</span><br><span class="line">    </span>&lt;%<span class="ruby"> cache [v45,<span class="variable">@todolist</span>] <span class="keyword">do</span> </span>%&gt;<span class="xml"></span><br><span class="line">      zzz</span><br><span class="line">    </span>&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;<span class="xml"></span><br><span class="line">  </span>&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;<span class="xml"></span><br><span class="line"></span>&lt;%<span class="ruby"> <span class="keyword">end</span> % </span>%&gt;<span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>GOOD:</p>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"></span>&lt;%<span class="ruby"> cache <span class="variable">@project</span> <span class="keyword">do</span> </span>%&gt;<span class="xml"></span><br><span class="line">  aaa</span><br><span class="line">  </span>&lt;%<span class="ruby"> cache <span class="variable">@todo</span> <span class="keyword">do</span> </span>%&gt;<span class="xml"></span><br><span class="line">    bbb</span><br><span class="line">    </span>&lt;%<span class="ruby"> cache <span class="variable">@todolist</span> <span class="keyword">do</span> </span>%&gt;<span class="xml"></span><br><span class="line">      ccc</span><br><span class="line">    </span>&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;<span class="xml"></span><br><span class="line">  </span>&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;<span class="xml"></span><br><span class="line"></span>&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;<span class="xml"></span></span><br></pre></td></tr></table></figure>
<p><strong>关于 Cache Digest 的延伸阅读</strong></p>
<ul>
<li><a href="https://github.com/rails/cache_digests" target="_blank" rel="external">cache_digests on github</a></li>
<li><a href="http://railscasts.com/episodes/387-cache-digests" target="_blank" rel="external">Cache Digests</a></li>
</ul>
<h3 id="No-10_Cells">No.10 Cells</h3><p>当同一个页面含有多个 Tab ，它会造成如下问题：</p>
<ul>
<li>Controller code 特别长，因为需要取出很多不同数据存入的变量</li>
<li>在 controller &amp; view 有性能问题不好找到</li>
<li>很难设置 action 级别的缓存</li>
</ul>
<p>BAD:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> <span class="inheritance">&lt; <span class="parent">ApplicationController</span></span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">show</span></span></span><br><span class="line">    <span class="variable">@user</span> = <span class="constant">User</span>.find(params[<span class="symbol">:id</span>])</span><br><span class="line">    <span class="variable">@recent_posts</span> = <span class="variable">@user</span>.recent_posts.limit(<span class="number">5</span>)</span><br><span class="line">    <span class="variable">@favorite_posts</span> = <span class="variable">@user</span>.favorite_posts.limit(<span class="number">5</span>)</span><br><span class="line">    <span class="variable">@recent_comments</span> = <span class="variable">@user</span>.comments.limit(<span class="number">5</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"></span>&lt;%=<span class="ruby"> render <span class="symbol">:partial</span> =&gt; <span class="string">"users/recent_post"</span>, <span class="symbol">:collection</span> =&gt; <span class="variable">@recent_posts</span> </span>%&gt;<span class="xml"></span><br><span class="line"></span>&lt;%=<span class="ruby"> render <span class="symbol">:partial</span> =&gt; <span class="string">"users/favorite_post"</span>, <span class="symbol">:collection</span> =&gt; <span class="variable">@favorite_posts</span> </span>%&gt;<span class="xml"></span><br><span class="line"></span>&lt;%=<span class="ruby"> render <span class="symbol">:partial</span> =&gt; <span class="string">"users/recent_comment"</span>, <span class="symbol">:collection</span> =&gt; <span class="variable">@recent_comments</span> </span>%&gt;<span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>GOOD:</p>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"></span>&lt;%=<span class="ruby"> render_cell <span class="symbol">:user</span>, <span class="symbol">:rencent_posts</span>, <span class="symbol">:user</span> =&gt; <span class="variable">@user</span> </span>%&gt;<span class="xml"></span><br><span class="line"></span>&lt;%=<span class="ruby"> render_cell <span class="symbol">:user</span>, <span class="symbol">:favorite_posts</span>, <span class="symbol">:user</span> =&gt; <span class="variable">@user</span> </span>%&gt;<span class="xml"></span><br><span class="line"></span>&lt;%=<span class="ruby"> render_cell <span class="symbol">:user</span>, <span class="symbol">:recent_comments</span>, <span class="symbol">:user</span> =&gt; <span class="variable">@user</span> </span>%&gt;<span class="xml"></span></span><br></pre></td></tr></table></figure>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> <span class="inheritance">&lt; <span class="parent">ApplicationController</span></span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">show</span></span></span><br><span class="line">    <span class="variable">@user</span> = <span class="constant">User</span>.find(params[<span class="symbol">:id</span>])</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserCell</span> <span class="inheritance">&lt; <span class="parent">Cell::Rails</span></span></span></span><br><span class="line">  cache <span class="symbol">:recent_posts</span>, <span class="symbol">:expires_in</span> =&gt; <span class="number">1</span>.hours</span><br><span class="line">  cache <span class="symbol">:favorite_posts</span>, <span class="symbol">:expires_in</span> =&gt; <span class="number">3</span>.hours</span><br><span class="line">  cache <span class="symbol">:recent_comments</span>, <span class="symbol">:expires_in</span> =&gt; <span class="number">5</span>.hours</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">recent_posts</span><span class="params">(args)</span></span></span><br><span class="line">   <span class="comment">#...</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">favorite_posts</span><span class="params">(args)</span></span></span><br><span class="line">    <span class="comment">#...</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">recent_comments</span><span class="params">(args)</span></span></span><br><span class="line">    <span class="comment">#...</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><strong>关于 Cells 的延伸阅读</strong></p>
<ul>
<li><a href="https://github.com/apotonick/cells" target="_blank" rel="external">cells on github</a></li>
</ul>
<h3 id="No-11_content_for_/_yield">No.11 content_for / yield</h3><p>根据 Yahoo 大神的建议，应该把 javascript 和 css 代码放在页面的最下面。以便加快加载，但是会造成一些问题。比如你自定义的 js 代码比 jquery 库更早加载，以至于无法运行你的代码。</p>
<p>例子1:</p>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"><span class="comment">&lt;!-- application.html.erb --&gt;</span></span><br><span class="line"></span>&lt;%=<span class="ruby"> stylesheet_link_tag <span class="string">"application"</span> </span>%&gt;<span class="xml"></span><br><span class="line"></span>&lt;%=<span class="ruby"> <span class="keyword">yield</span> </span>%&gt;<span class="xml"></span><br><span class="line"></span>&lt;%=<span class="ruby"> javascript_include_tag <span class="string">"application"</span> </span>%&gt;<span class="xml"></span><br><span class="line"></span>&lt;%=<span class="ruby"> <span class="keyword">yield</span> <span class="symbol">:page_specific_javascript</span> </span>%&gt;<span class="xml"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- main.html.erb --&gt;</span></span><br><span class="line"></span>&lt;%=<span class="ruby"> content_for <span class="symbol">:page_specific_javascript</span> <span class="keyword">do</span> </span>%&gt;<span class="xml"></span><br><span class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>= "<span class="attribute">text</span>/<span class="attribute">javascript</span>"&gt;</span><span class="actionscript"></span><br><span class="line">    <span class="comment">// your script here</span></span><br><span class="line">  </span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"></span>&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;<span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>例子2:</p>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"><span class="comment">&lt;!-- application.html.erb --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"main"</span>&gt;</span></span><br><span class="line">  </span>&lt;%=<span class="ruby"> <span class="keyword">yield</span> </span>%&gt;<span class="xml"></span><br><span class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"sidebar"</span>&gt;</span></span><br><span class="line">  </span>&lt;%=<span class="ruby"> <span class="keyword">yield</span> <span class="symbol">:sidebar</span> </span>%&gt;<span class="xml"></span><br><span class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- main.html.erb --&gt;</span></span><br><span class="line"></span>&lt;%=<span class="ruby"> content_for <span class="symbol">:sidebar</span> <span class="keyword">do</span> </span>%&gt;<span class="xml"></span><br><span class="line">  </span>&lt;%=<span class="ruby"> render <span class="string">"ad/foo"</span></span>%&gt;<span class="xml"></span><br><span class="line"></span>&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;<span class="xml"></span></span><br></pre></td></tr></table></figure>
<h3 id="No-12_Decoration_in_Controller">No.12 Decoration in Controller</h3><p>有个别情况，可以把一些代码放在 controller 中</p>
<p>BAD:</p>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"></span>&lt;%=<span class="ruby"> content_for <span class="symbol">:meta</span> <span class="keyword">do</span> </span>%&gt;<span class="xml"></span><br><span class="line">  <span class="tag">&lt;<span class="title">meta</span> <span class="attribute">content</span>=<span class="value">"xdite's blog"</span> <span class="attribute">name</span>=<span class="value">"description"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">meta</span> <span class="attribute">content</span>=<span class="value">"Blog.XDite.net"</span> <span class="attribute">property</span>=<span class="value">"og:title"</span>&gt;</span></span><br><span class="line"></span>&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;<span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>GOOD:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span></span></span><br><span class="line">  <span class="variable">@blog</span> = current_blog</span><br><span class="line">  drop_blog_title <span class="variable">@blog</span>.name</span><br><span class="line">  drop_blog_descption <span class="variable">@blog</span>.description</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"></span>&lt;%=<span class="ruby"> stylesheet_tag <span class="string">"application"</span> </span>%&gt;<span class="xml"></span><br><span class="line"></span>&lt;%=<span class="ruby"> render_page_title </span>%&gt;<span class="xml"></span><br><span class="line"></span>&lt;%=<span class="ruby"> render_page_descrption </span>%&gt;<span class="xml"></span></span><br></pre></td></tr></table></figure>
<h3 id="No-13_Decoration_using_I18n">No.13 Decoration using I18n</h3><p>善用 I18n 也可以帮你减少一部分 View 代码</p>
<p>BAD:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_user_geneder</span><span class="params">(user)</span></span></span><br><span class="line">  <span class="keyword">if</span> user.gender == <span class="string">"male"</span></span><br><span class="line">    <span class="string">"男 (Male)"</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="string">"⼥女 (Female)"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>GOOD:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_user_gender</span><span class="params">(user)</span></span></span><br><span class="line">  <span class="constant">I18n</span>.t(<span class="string">"users.gender_desc.<span class="subst">#&#123;user.geneder&#125;</span>"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="No-14_Decoration_using_Decorator">No.14 Decoration using Decorator</h3><p>不要把所有代码都往 Model 中扔，下面的代码演示了一种情况，你需要格式化一种显示发布时间的方法</p>
<p>BAD:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># first helper</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_article_publish_status</span><span class="params">(article)</span></span></span><br><span class="line">  <span class="keyword">if</span> article.published?</span><br><span class="line">    <span class="string">"Published at <span class="subst">#&#123;article.published_at.strftime(<span class="string">'%A, %B %e'</span>)&#125;</span>"</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="string">"Unpublished"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># then model method</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span> <span class="inheritance">&lt; <span class="parent">ActiveRecord::Base</span></span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">human_publish_status</span></span></span><br><span class="line">    <span class="keyword">if</span> published?</span><br><span class="line">      <span class="string">"Published at <span class="subst">#&#123;article.published_at.strftime(<span class="string">'%A, %B %e'</span>)&#125;</span>"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="string">"Unpublished"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># then ...</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span> <span class="inheritance">&lt; <span class="parent">ActiveRecord::Base</span></span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">human_publish_status</span></span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">human_publish_time</span></span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">human_author_name</span></span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="comment">#........</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># at last</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span> <span class="inheritance">&lt; <span class="parent">ActiveRecord::Base</span></span></span></span><br><span class="line">  <span class="keyword">include</span> <span class="constant">HumanArticleAttributes</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>下面的代码演示使用 <a href="https://github.com/drapergem/draper" target="_blank" rel="external">https://github.com/drapergem/draper</a> 之后</p>
<p>GOOD:</p>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"></span>&lt;%=<span class="ruby"> <span class="variable">@article</span>.publication_status </span>%&gt;<span class="xml"></span></span><br></pre></td></tr></table></figure>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleDecorator</span> <span class="inheritance">&lt; <span class="parent">Draper::Decorator</span></span></span></span><br><span class="line">  delegate_all</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">publication_status</span></span></span><br><span class="line">    <span class="keyword">if</span> published?</span><br><span class="line">      <span class="string">"Published at <span class="subst">#&#123;published_at&#125;</span>"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="string">"Unpublished"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">published_at</span></span></span><br><span class="line">    object.published_at.strftime(<span class="string">"%A, %B %e"</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span></span></span><br><span class="line">  <span class="variable">@article</span> = <span class="constant">Article</span>.find(params[<span class="symbol">:id</span>]).decorate</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><strong>关于 draper 的延伸阅读</strong></p>
<ul>
<li><a href="https://github.com/drapergem/draper" target="_blank" rel="external">draper on github</a></li>
<li><a href="https://www.ruby-toolbox.com/categories/rails_presenters" target="_blank" rel="external">rails_presenters gems</a></li>
</ul>
<h3 id="No-15_Decoration_using_View_Object">No.15 Decoration using View Object</h3><p>有时候，我们希望在用户中，不列出我自己</p>
<p>BAD:</p>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">dl</span> <span class="attribute">class</span>=<span class="value">"event-detail"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">dt</span>&gt;</span>Event Host<span class="tag">&lt;/<span class="title">dt</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">dd</span>&gt;</span></span><br><span class="line">    </span>&lt;%<span class="ruby"> <span class="keyword">if</span> <span class="variable">@event</span>.host == current_user </span>%&gt;<span class="xml"></span><br><span class="line">      You</span><br><span class="line">    </span>&lt;%<span class="ruby"> <span class="keyword">else</span> </span>%&gt;<span class="xml"></span><br><span class="line">      </span>&lt;%=<span class="ruby"> <span class="variable">@event</span>.host.name </span>%&gt;<span class="xml"></span><br><span class="line">    </span>&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;<span class="xml"></span><br><span class="line">  <span class="tag">&lt;/<span class="title">dd</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">dt</span>&gt;</span>Participants<span class="tag">&lt;/<span class="title">dt</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">dd</span>&gt;</span></span><br><span class="line">    </span>&lt;%=<span class="ruby"> <span class="variable">@event</span>.participants.reject &#123; |p| p == current_user &#125;.map(&amp;<span class="symbol">:name</span>).join(<span class="string">", "</span>) </span>%&gt;<span class="xml"></span><br><span class="line">  <span class="tag">&lt;/<span class="title">dd</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">dl</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>GOOD:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventDetailView</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(template, event, current_user)</span></span></span><br><span class="line">    <span class="variable">@template</span> = template</span><br><span class="line">    <span class="variable">@event</span> = event</span><br><span class="line">    <span class="variable">@current_user</span> = current_user</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">host</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="variable">@event</span>.host == <span class="variable">@current_user</span></span><br><span class="line">      <span class="string">"You"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="variable">@event</span>.host.name</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">participant_names</span></span></span><br><span class="line">    participants.map(&amp;<span class="symbol">:name</span>).join(<span class="string">", "</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  private</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">participants</span></span></span><br><span class="line">    <span class="variable">@event</span>.participants.reject &#123; |p| p == <span class="variable">@current_user</span> &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight erb"><table><tr><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">dl</span> <span class="attribute">class</span>=<span class="value">"event-detail"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">dt</span>&gt;</span>Host<span class="tag">&lt;/<span class="title">dt</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">dd</span>&gt;</span></span>&lt;%=<span class="ruby"> event_detail.host </span>%&gt;<span class="xml"><span class="tag">&lt;/<span class="title">dd</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">dt</span>&gt;</span>Participants<span class="tag">&lt;/<span class="title">dt</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">dd</span>&gt;</span></span>&lt;%=<span class="ruby"> event_detail.participant_names </span>%&gt;<span class="xml"><span class="tag">&lt;/<span class="title">dd</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">dl</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h3 id="No-16_Form_builder">No.16 Form builder</h3><ul>
<li>simple_form</li>
<li>bootstrap_form</li>
</ul>
<h3 id="No-17_Form_Object">No.17 Form Object</h3><p>在 FORM 中包装逻辑，而不是 model 或 controller。比如我们经常遇到的一个情况，只有同意某某条款才能继续注册表单。</p>
<p><strong>Reform</strong> Decouples your models from form validation, presentation and workflows.</p>
<p><a href="https://github.com/apotonick/reform" target="_blank" rel="external">https://github.com/apotonick/reform</a></p>
<h3 id="No-18_Policy_Object_/_Rule_Engine">No.18 Policy Object / Rule Engine</h3><p>权限控制</p>
<p>BAD:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_post_edit_option</span><span class="params">(post)</span></span></span><br><span class="line">  <span class="keyword">if</span> post.user == current_user || current_user.admin?</span><br><span class="line">    render <span class="symbol">:partial</span> =&gt; <span class="string">"post/edit_bar"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>针对于这种情况建议使用权限控制系统，另外近来似乎大家都从 Cancan 转移到 Pundit 去了</p>
<p><strong>Pundit</strong> Minimal authorization through OO design and pure Ruby classes</p>
<p><a href="https://github.com/elabs/pundit" target="_blank" rel="external">https://github.com/elabs/pundit</a></p>
<p><strong>Cancan</strong> Authorization Gem for Ruby on Rails</p>
<p><a href="https://github.com/ryanb/cancan" target="_blank" rel="external">https://github.com/ryanb/cancan</a></p>
<h2 id="总结">总结</h2><ul>
<li>总是假设这块正在实现的功能代码需要 decorated（修饰）</li>
<li>把逻辑移到 methods/classes</li>
<li>避免在 View/Helper 中做数据库查询</li>
<li>当代码很难懂的时候，把它抽取到一个新的控制中心比如：form object, Policy Object 之类的</li>
</ul>
<h2 id="延伸阅读">延伸阅读</h2><ul>
<li><a href="http://blog.xdite.net" target="_blank" rel="external">http://blog.xdite.net</a></li>
<li><a href="https://github.com/bloudermilk/maintainable_templates" target="_blank" rel="external">https://github.com/bloudermilk/maintainable_templates</a> <a href="http://pivotallabs.com/form-backing-objects-for-fun-and-profit/" target="_blank" rel="external">http://pivotallabs.com/form-backing-objects-for-fun-and-profit/</a></li>
<li><a href="http://saturnflyer.com/blog/jim/2013/10/21/how-to-make-your-code-imply-responsibilities/" target="_blank" rel="external">http://saturnflyer.com/blog/jim/2013/10/21/how-to-make-your-code-imply-responsibilities/</a></li>
<li><a href="http://objectsonrails.com/" target="_blank" rel="external">http://objectsonrails.com/</a></li>
</ul>
<h2 id="出处">出处</h2><p>以上内容由 <strong>Victor</strong> 整理，本人只是记录在blog中。</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  

  <nav id="pagination">
  
  
    <a href="/archives/2014/page/2/" class="next">下一页</a>
  
  <div class="clearfix"></div>
</nav>

</div>
  </div>
  <footer id="footer"><div class="copyright">
  
  &copy; 2016 <a href="/">shooter</a>
  
</div>
<div class="theme-copyright">
  Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a>
   | 
  Redesign by <a href="http://heroicyang.com/" target="_blank">Heroic Yang</a>
</div>
<div class="clearfix"></div></footer>
  <script src="//cdn.staticfile.org/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/scale.fix.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
  var disqus_shortname = 'shooterme';

  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  (function($){
    $('.fancybox').fancybox();
  })(jQuery);
</script>

<script type="text/javascript">
  (function(){
    var infos = new Object();

    infos['qq'] ='1458643975';
    infos['mobile'] ='18612621540';
    infos['extend'] ='\\u90b9\\u5029\\u96ef';

    console.log(infos);
  })();
</script>


</body>
</html>